# Test: Incomplete Auth Recovery
# Tests the flow when user abandons OAuth/OTP during sign-in
#
# This is the exact scenario you reported - user signs in, gets to OTP screen,
# leaves the app, then comes back. We should handle this gracefully.
#
# Expected behavior:
# 1. User starts sign-in (OAuth completes)
# 2. Grid OTP modal appears
# 3. User leaves/closes app without completing OTP
# 4. User returns to app
# 5. App detects incomplete auth state
# 6. App logs user out and shows login screen (clean state)

appId: ${APP_ID}
tags:
  - auth
  - edge-case
  - incomplete-auth

---

# Step 1: Start on login screen
- assertVisible: "Continue with Google"

# Step 2: Begin sign-in
- tapOn: "Continue with Google"
- waitForAnimationToEnd:
    timeout: ${TIMEOUT_LONG}

# Step 3: OTP modal should appear
- assertVisible:
    text: "Enter verification code"
    timeout: ${TIMEOUT_LONG}

# Step 4: SIMULATE USER LEAVING - Press back or close modal
- pressKey: Back

# Step 5: SIMULATE APP RESTART - Stop and relaunch
- stopApp
- launchApp
- waitForAnimationToEnd:
    timeout: ${TIMEOUT_MEDIUM}

# Step 6: App should detect incomplete auth and show login screen
# (User has Supabase session but no Grid session = incomplete)
- assertVisible:
    text: "Continue with Google"
    timeout: ${TIMEOUT_LONG}

# Step 7: Verify we're logged out (not stuck on loading screen!)
- assertNotVisible: "Loading..."
- assertNotVisible: "Enter verification code"

# SUCCESS: App gracefully recovered from incomplete auth!

