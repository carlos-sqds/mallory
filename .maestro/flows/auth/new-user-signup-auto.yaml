# Test: New User Signup with Mailosaur OTP (Simplified)
# Fully automated test using real Grid OTP from Mailosaur
# 
# Prerequisites:
# - apps/client/.env.test exists with MAILOSAUR_API_KEY and MAILOSAUR_SERVER_ID
# - Backend server running
# - Mailosaur email address: mallory-testing@SERVERID.mailosaur.net
#
# Flow:
# 1. Click "Continue with Google" 
# 2. OAuth completes
# 3. Grid sends OTP email
# 4. Maestro waits for OTP modal
# 5. Background: Bun script fetches OTP from Mailosaur
# 6. Maestro enters OTP automatically  
# 7. User lands on chat

appId: ${APP_ID}
tags:
  - auth
  - mailosaur
  - automated

---

# Verify login screen
- assertVisible: "Continue with Google"

# Start OAuth
- tapOn: "Continue with Google"
- waitForAnimationToEnd:
    timeout: 30000

# Wait for OTP modal (Grid sends email during this time)
- assertVisible:
    text: "Enter verification code"
    timeout: 30000

# Pause to let Grid send the email (give it 5 seconds)
- waitForAnimationToEnd:
    timeout: 5000

# Run Mailosaur script in background (non-blocking)
# This will create .maestro/.latest-otp file when ready
- runScript: |
    cd apps/client && bun maestro-mailosaur-otp.ts ${TEST_EMAIL} &

# Wait for OTP file to appear (script is fetching email)
# Poll every second for up to 2 minutes
- runScript: |
    for i in {1..120}; do
      if [ -f apps/client/.maestro/.latest-otp ]; then
        cat apps/client/.maestro/.latest-otp
        exit 0
      fi
      sleep 1
    done
    echo "TIMEOUT"
    exit 1

# The script output is now in ${output.stdout}
# Enter the OTP
- inputText: ${output.stdout}

# Tap verify
- tapOn: "Verify"
- waitForAnimationToEnd:
    timeout: 15000

# Should land on chat
- assertVisible: "Chat"

# Cleanup
- runScript: rm -f apps/client/.maestro/.latest-otp

# SUCCESS!

